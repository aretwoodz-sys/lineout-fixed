<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lineout Sync – Fixed Row Population</title>
  <style>
    body{font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#f7fafc; color:#0f172a}
    .wrap{max-width:1100px;margin:20px auto;padding:16px;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    input,button{padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px}
    button{background:#2563eb;color:#fff;border-color:#1d4ed8;cursor:pointer}
    button.secondary{background:#fff;color:#111;border-color:#cbd5e1}
    button:disabled{opacity:.6;cursor:not-allowed}
    #status{font-size:13px;color:#047857;min-height:1.2em;margin:6px 0}
    table{border-collapse:separate;border-spacing:0;width:100%;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden}
    th,td{border-bottom:1px solid #e5e7eb;padding:8px 10px;text-align:center}
    thead th{background:#f3f4f6;position:sticky;top:0}
    tbody tr:nth-child(odd){background:#fcfcff}
    .notes{width:100%;box-sizing:border-box;padding:6px;border:1px solid #e5e7eb;border-radius:6px}
    .row-spliced{background:#fffbe6}
    .row-both{background:#eaffe6}
    .row-incomplete{background:#ffe5e5;text-decoration:line-through}
    .muted{color:#64748b}
    .small{font-size:12px}
    .right{margin-left:auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .card{background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:10px}
    code{background:#f1f5f9;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<div class="wrap">
  <h1 style="margin:4px 0 8px">Lineout Sync (rows population fix)</h1>
  <div class="toolbar">
    <label class="small">Room:</label>
    <input id="room" placeholder="e.g. demo-room-123" style="min-width:220px">
    <button id="btnInit">Init + Listen</button>
    <button id="btnSaveSample" class="secondary">Save Sample Rows</button>
    <div class="right small muted">Logged in: <span id="who" class="muted">—</span></div>
  </div>
  <div id="status"></div>

  <div class="grid" style="margin:12px 0">
    <div class="card small">
      <strong>Helpers (window):</strong>
      <div><code>saveRowsToCloud(room, rows, meta?)</code></div>
      <div><code>applyRows(rows)</code> will be called on remote updates.</div>
      <div><code>window.dispatchEvent(new CustomEvent('lineout:save', {detail:{room,rows,meta}}))</code></div>
    </div>
    <div class="card small">
      <strong>Schema:</strong>
      <div><code>/lineouts/{room}</code> =&gt; { title, rows: Array&lt;Row&gt;, updatedAt, ownerUid, public }</div>
      <div>Row =&gt; { id?, play?, team?, quarter?, checked?, notes?, bg? }</div>
    </div>
  </div>

  <h3 style="margin:16px 0 8px">Table (default renderer)</h3>
  <div id="tableWrap">
    <table id="tbl">
      <thead>
      <tr>
        <th>#</th>
        <th>Play</th>
        <th>Team</th>
        <th>Qtr</th>
        <th>Done</th>
        <th>Notes</th>
      </tr>
      </thead>
      <tbody id="tbody">
      </tbody>
    </table>
    <div class="small muted" style="margin-top:8px">If your page defines its own <code>applyRows(rows)</code>, that will be used instead of this table.</div>
  </div>
</div>

<script type="module">
/**
 * LINEOUT SYNC CORE
 * - Anonymous auth
 * - Firestore doc: /lineouts/{room}
 * - Robust onSnapshot => applyRows(rows)
 * - saveRowsToCloud(room, rows, meta)
 * - Debounce + loop-guard so remote updates don't echo locally forever
 */

// --- Firebase (use global FIREBASE_CONFIG if present) ---
const DEFAULT_FB = {
  apiKey: "AIzaSyB-GAwSnt5mplQQ-0GV78Ud1v-JfqFuz0o",
  authDomain: "lineout-3a851.firebaseapp.com",
  projectId: "lineout-3a851",
  storageBucket: "lineout-3a851.firebasestorage.app",
  messagingSenderId: "133642224320",
  appId: "1:133642224320:web:b47587ea9bbf80ea426325",
  measurementId: "G-14R61YSV5V"
};
const FB = window.FIREBASE_CONFIG || DEFAULT_FB;

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

const app = initializeApp(FB);
const db = getFirestore(app);
const auth = getAuth(app);

// --- UI helpers ---
const $ = (sel)=>document.querySelector(sel);
const roomInput = $('#room');
const statusEl = $('#status');
const whoEl = $('#who');
const tbody = $('#tbody');

function setStatus(msg, isErr=false){
  statusEl.textContent = msg || '';
  statusEl.style.color = isErr ? '#b91c1c' : '#047857';
  console.log('[status]', msg);
}
function id() { return Math.random().toString(36).slice(2,10); }

// --- Auth ---
onAuthStateChanged(auth, (u)=>{
  if(u){
    whoEl.textContent = `anon:${u.uid.slice(0,6)}…`;
  } else {
    whoEl.textContent = '—';
  }
});
try {
  await signInAnonymously(auth);
} catch(e){
  console.error('Anon auth failed', e);
  setStatus('Anonymous auth failed. Check Firebase config.', true);
}

// --- Sync state ---
let unsub = null;
let lastWriteToken = null; // loop guard
let lastServerVersion = null;

// convert any inbound value to normalized rows []
function normalizeRows(rows){
  if(!Array.isArray(rows)) return [];
  // Map to a canonical shape
  return rows.map((r, i)=> ({
    id: r?.id || `${i+1}`,
    play: r?.play ?? r?.Play ?? '',
    team: r?.team ?? r?.Team ?? '',
    quarter: r?.quarter ?? r?.Quarter ?? '',
    checked: !!(r?.checked ?? r?.done ?? false),
    notes: r?.notes ?? '',
    bg: r?.bg ?? ''
  }));
}

// --- Default renderer if host doesn't provide applyRows ---
function defaultApplyRows(rows){
  tbody.innerHTML = '';
  if(!rows || !rows.length){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 6;
    td.className = 'muted';
    td.textContent = 'No rows yet.';
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }
  rows.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    if(r.bg === 'spliced') tr.classList.add('row-spliced');
    if(r.bg === 'both') tr.classList.add('row-both');
    if(r.bg === 'incomplete') tr.classList.add('row-incomplete');

    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${escapeHtml(r.play || '')}</td>
      <td>${escapeHtml(r.team || '')}</td>
      <td>${escapeHtml(r.quarter || '')}</td>
      <td><input type="checkbox" data-id="${r.id}" class="row-done" ${r.checked ? 'checked':''}></td>
      <td><textarea class="notes" data-id="${r.id}" rows="1" placeholder="notes...">${r.notes ? escapeHtml(r.notes) : ''}</textarea></td>
    `;
    tbody.appendChild(tr);
  });

  // wire change handlers -> save
  tbody.querySelectorAll('.row-done').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const rid = cb.getAttribute('data-id');
      const current = grabRowsFromDOM();
      current.forEach(r=>{ if(r.id===rid){ r.checked = cb.checked; } });
      if(window._activeRoom) saveRowsToCloud(window._activeRoom, current, { source:'checkbox' });
    });
  });
  tbody.querySelectorAll('.notes').forEach(ta=>{
    ta.addEventListener('change', ()=>{
      const rid = ta.getAttribute('data-id');
      const current = grabRowsFromDOM();
      current.forEach(r=>{ if(r.id===rid){ r.notes = ta.value; } });
      if(window._activeRoom) saveRowsToCloud(window._activeRoom, current, { source:'notes' });
    });
  });
}

// If host page defines its own, we'll call that instead
window.applyRows = window.applyRows || defaultApplyRows;

// helper to pull rows back from DOM (default table)
function grabRowsFromDOM(){
  const rows = [];
  tbody.querySelectorAll('tr').forEach((tr, i)=>{
    const cells = tr.querySelectorAll('td');
    if(cells.length < 6) return;
    const done = tr.querySelector('input.row-done');
    const notes = tr.querySelector('textarea.notes');
    rows.push({
      id: (done?.getAttribute('data-id')) || `${i+1}`,
      play: (cells[1]?.textContent || '').trim(),
      team: (cells[2]?.textContent || '').trim(),
      quarter: (cells[3]?.textContent || '').trim(),
      checked: !!done?.checked,
      notes: notes?.value || '',
      bg: tr.classList.contains('row-incomplete') ? 'incomplete' : tr.classList.contains('row-both') ? 'both' : tr.classList.contains('row-spliced') ? 'spliced' : ''
    });
  });
  return rows;
}

// --- Cloud I/O ---
async function ensureDoc(room, ownerUid){
  const ref = doc(db, 'lineouts', room);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref, {
      title: room,
      rows: [],
      public: true,
      ownerUid: ownerUid || null,
      updatedAt: serverTimestamp()
    });
  }
  return ref;
}

// Listen for server changes and applyRows()
async function startListening(room){
  if(unsub){ try{unsub();}catch{} unsub=null; }
  const u = auth.currentUser;
  const ref = await ensureDoc(room, u?.uid);
  window._activeRoom = room;

  unsub = onSnapshot(ref, (docSnap)=>{
    if(!docSnap.exists()) {
      setStatus('Document missing (created placeholder).');
      return;
    }
    const data = docSnap.data() || {};
    const token = data.__writeToken;
    const rows = normalizeRows(data.rows || []);
    lastServerVersion = JSON.stringify(rows);
    // Loop guard: if this update was just written by us, ignore applying to DOM
    if(token && token === lastWriteToken){
      console.log('[onSnapshot] Skipping self-echo');
      return;
    }
    console.log('[onSnapshot] Applying rows from server:', rows);
    try{
      window.applyRows(rows);
      setStatus(`Loaded ${rows.length} row(s) from cloud.`);
    }catch(e){
      console.error('applyRows failed', e);
      setStatus('applyRows failed — see console.', true);
    }
  }, (err)=>{
    console.error('onSnapshot error', err);
    setStatus('Listen failed — check permissions / network.', true);
  });

  setStatus(`Listening to room “${room}”`);
}

// Save rows up to cloud (debounced, with token)
let saveTimer = null;
function saveRowsToCloud(room, rows, meta={}){
  const ref = doc(db, 'lineouts', room);
  const token = id();
  lastWriteToken = token; // mark self
  const payload = {
    ...(meta?.title ? { title: meta.title } : {}),
    rows: normalizeRows(rows),
    updatedAt: serverTimestamp(),
    __writeToken: token
  };
  clearTimeout(saveTimer);
  saveTimer = setTimeout(async ()=>{
    try{
      await setDoc(ref, payload, { merge: true });
      console.log('[save] wrote rows', payload);
      setStatus(`Saved ${payload.rows.length} row(s).`);
    }catch(e){
      console.error('save failed', e);
      setStatus('Save failed — check console / rules.', true);
    }
  }, 120);
}
window.saveRowsToCloud = saveRowsToCloud;

// Event bridge so any script can dispatch a save
window.addEventListener('lineout:save', (ev)=>{
  const { room, rows, meta } = ev.detail || {};
  if(!room || !Array.isArray(rows)){ console.warn('lineout:save missing room/rows'); return; }
  saveRowsToCloud(room, rows, meta || {});
});

// --- UI wiring ---
$('#btnInit').addEventListener('click', ()=>{
  const r = roomInput.value.trim();
  if(!r){ setStatus('Enter a Room ID.', true); return; }
  startListening(r);
});
$('#btnSaveSample').addEventListener('click', async ()=>{
  const r = roomInput.value.trim();
  if(!r){ setStatus('Enter a Room ID.', true); return; }
  const sample = [
    { id:'1', play:'Lineout A', team:'Blue', quarter:'1', checked:false, notes:'' },
    { id:'2', play:'Lineout B', team:'Red',  quarter:'2', checked:true,  notes:'looks good', bg:'both' },
    { id:'3', play:'Lineout C', team:'Blue', quarter:'3', checked:false, notes:'fix throw', bg:'spliced' }
  ];
  saveRowsToCloud(r, sample, { title: 'Sample Sheet' });
});

// --- Utils ---
function escapeHtml(str){
  return (str||'').replace(/[&<>"']/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[s]));
}
</script>
</body>
</html>
